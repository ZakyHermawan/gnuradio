from xml.dom import minidom

def make_cpuid_generic_c(dom) :
    tempstring = "";
    tempstring = tempstring + "/*this file is auto_generated by volk_register.py*/\n\n";
    tempstring = tempstring + "#include <volk/volk_cpu.h>\n"
    tempstring = tempstring + "#include <volk/volk_config_fixed.h>\n"
    tempstring = tempstring + "\n\n"
    
    for domarch in dom:
        if str(domarch.attributes["type"].value) == "all":
            arch = str(domarch.attributes["name"].value);
            tempstring = tempstring + "int i_can_has_" + arch + " () {\n"
            tempstring = tempstring + "    return 1;\n"
            tempstring = tempstring + "}\n\n"
    
        else:
            arch = str(domarch.attributes["name"].value);
            tempstring = tempstring + "int i_can_has_" + arch + " () {\n"
            tempstring = tempstring + "  return 0;\n"
            tempstring = tempstring + "}\n\n"

    tempstring = tempstring + "void volk_cpu_init() {\n";
    for domarch in dom:
        arch = str(domarch.attributes["name"].value);
        tempstring = tempstring + "    volk_cpu.has_" + arch + " = &i_can_has_" + arch + ";\n"
    tempstring = tempstring + "}\n\n"

    tempstring = tempstring + "unsigned int volk_get_lvarch() {\n";
    tempstring = tempstring + "    unsigned int retval = 0;\n"
    tempstring = tempstring + "    volk_cpu_init();\n"
    for domarch in dom:
        arch = str(domarch.attributes["name"].value);
        tempstring = tempstring + "    retval += volk_cpu.has_" + arch + "() << LV_" + arch.swapcase() + ";\n"
    tempstring = tempstring + "    return retval;\n"
    tempstring = tempstring + "}\n\n"

    return tempstring;
